---
layout:     post
title:     n1刷openwrt做主路由拨号上网
subtitle:   u盘启动armbian，刷入openwrt镜像
date:        2019-11-01 18:26:30
author:     "jkdigger"
header-img: 
catalog: true
tags:
    - n1刷机
---





## 前言

N1 是不能直接刷入 Openwrt 的，目前有两种方法

- 一种是把 Openwrt 系统写入到 U 盘，设置 U 盘启动，通过 U 盘来使用 Openwrt，这种方法效率不高，毕竟 U 盘的读写速度是没办法和自带的闪存比的。
- 另一种是通过 Armbain 系统，把 Openwrt 刷入到 N1 的 EMMC 中，这种方法更好，我目前也是采取这种方法。

## 1. 准备工作

- 已降级的n1盒子一个（是否刷入固件EMMC的皆可）
- 一个 已刷入XQ7大神的armbian 5.60版的 u盘
- openwrt固件

### 01 查看盒子ip

- n1连接网线到主路由lan口，通电
- 获取ip

> 方法一：连接显示器和键盘，登入电视界面查看ip
>
> 方法二：n1通电，电脑上打开scanport工具，即可获取n1的ip
>
> ```
> scanport设定
> 起始ip 192.168.5.1（路由器网关）
> 结束ip 192.168.5.255
> 端口 22
> 超时 200
> 线程 10
> ```

### 02 设置n1从u盘启动

- 电脑上打开cmd，输入如下命令

```
adb connect N1的IP地址
adb shell reboot update
```

- 在系统关机的过程中，**插入写好的系统U盘**，此时连接显示器会看到四只企鹅。

### 03 刷入openwrt固件

-  通过 [MobaXterm](https://mobaxterm.mobatek.net/) 软件连接 N1 

```
点击session->点击SSH->输入ip和用户名
```

-   执行脚本，将 EMMC 分成两个分区，并将 Armbian 写入到 EMMC 中： 

```
/boot/create-mbr-linux.sh
./install.sh
```

- 在**MobaXterm**能看到 root 目录的文件，把 Op固件拖入到 root 目录中 （按中间粘贴）
-  上传完成后，输入下列命令

```
创建一个emmc2文件夹
mkdir /emmc2

将Armbian所在的分区挂载到emmc2文件夹
mount /dev/mmcblk1p2 /emmc2

删除Armbian的所有文件
rm -rf /emmc2/*

挂载Openwrt镜像文件，名字以你自己镜像文件为准
losetup -P -f --show N1_openwrt_clash_wifi_20190527.img

挂载指定的文件夹
mount /dev/loop0p2 /media

将Openwrt的所有文件复制到Armbian分区文件夹emmc2
cp -R /media/* /emmc2

卸载所有的挂载
umount /media
losetup -d /dev/loop0
umount /emmc2

关机
poweroff
```



- 先拔掉电源，再拔掉 U 盘，n1重新通电
- pc和n1网线连接

## 2. 主路由设置

### 01 电脑和n1用网线连接

- 浏览器中输入192.168.10.1，登入op

```
用户名 root
密码 password
```

- 网络->无线->基本设置

```
这里可以选 2.4G 或者 5G（只能二选一），模式目前只支持 legacy，注意信道不能选自动（随便选个信道即可），否则会没有 wifi 信号。最后点击保存应用。比如

工作频率：legacy、5g、36（5180MHZ）
```

- 点击[保存应用]

### 02 拔掉电脑网线，电脑连n1wifi

- wifi名为OpenWrt

- 浏览器中输入192.168.10.1，登入op系统

```
用户名 root
密码 password
```

- 网络->接口->修改LAN->物理设置

```
取消eth0接口，点击保存

注意：不要点应用
```

- 回到接口主界面，新建一个WAN口

```
名称：WAN
协议：PPPoE
勾选eth0
```

- 点提交，在基本设置中输入宽带帐号，保存

```
PAP用户名：
PAP密码：
```

- 接口->WAN->防火墙设置

```
勾选第三个  WAN（空）
```

- 保存

### 03 网线一端连n1，一端连电信光猫

- 点击网络->接口
- [VPN WAN LAN]界面：点击三个[WAN] -[连接]
- 获取到ip，拨号成功
- 网络->防火墙->自定义规则，复制下面这一段

```
iptables -t nat -I POSTROUTING -j MASQUERADE
```

- 重启防火墙
- 网络->诊断->点击ping（可以ping通官网表示连接成功）
- 重启n1

## 3. 修改openwrt wifi密码

- 浏览器中输入192.168.10.1，登入op

```
用户名 root
密码 password
```

-  网络->无线 
- ssid处，点击修改
- 接口配置：无线安全

```
加密方式 wpa2-psk
算法 自动
密码 自定义
```

- 保存并应用

## 参考资料

- [斐讯N1 eMMC 刷入OpenWRT系统教程笔记]( https://www.maxlicheng.com/embedded/36.html )
- [橙子固件下载]( https://www.maxlicheng.com/openwrt/216.html )
- [n1主路由设置]( https://www.maxlicheng.com/openwrt/51.html )
- [斐讯 N1 折腾记录]( https://xsinger.me/diy/1010.html )