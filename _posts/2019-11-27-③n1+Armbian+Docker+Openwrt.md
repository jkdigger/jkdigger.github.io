---
layout:     post
title:      n1+Armbian+Docker+Openwrt
subtitle:   n1盘路由方案
date:       2019-11-27 18:00:00
author:     "jkdigger"
header-img: 
catalog: true
tags:
    - n1刷机
---





## 使用效果

- 百兆宽带下使用k2p做为主路由，n1作为旁路由时youtube测速结果。

![](https://raw.githubusercontent.com/jkdigger/picForBlog/master/images/20191127115520.jpg)

## 准备工作

- 已经刷入Armbian的n1一台
- 获取阿里云镜像加速地址

> 1.登陆 dev.aliyun.com
> 2.管理控制台->镜像库->镜像加速器->加速器
> 3.复制加速器地址 

## 1. 安装docker

-  调用阿里云的镜像 

```
curl -fsSL https://get.docker.com -o get-docker.sh

sh get-docker.sh --mirror Aliyun
```

-  等待安装完成
-  逐行执行：调用镜像加速器

```
mkdir -p /etc/docker

tee /etc/docker/daemon.json <<-'EOF'

{

"registry-mirrors": ["https://加速器地址.com"]

}

EOF

systemctl daemon-reload

systemctl restart docker
```

## 2. 安装docker图形化管理

-  安装docker图形化管理Portainer

```
docker volume create portainer_data

docker run -d -p 9000:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer:linux-arm64
```

-  安装完成后，浏览器中输入`N1ip:9000`
-  创建用户，用户名和密码
-  选择local
-  点击[connect]
-  点击loacl up→点击[Dashboard]

> 此时看到右方的containers有容器，表示部署成功。
>
> 以后若要完整卸载某容器，先就勾选中容器，然后点remover，然后在image删除对应的镜像，若还有容器对应的volume，也要删除。

## 3. 设置Armbian静态ip和DNS

> 目的
>
> - 改静态是为了在安装docker的op下，能登录armbian的ssh
> - 改DNS是为了让armbian正常解析域名

### 01 设置静态ip

- moba登入n1
- 下载`/etc/network`下的interfaces文件
- 用记事本打开interfaces文件

> - 192.168.2.19改成**你刚刚登入的n1的ip**。否则无法登入docker 图形管理界面。
> - 192.168.2.1为主路由ip，改为你的主路由

```
source /etc/network/interfaces.d/*

# Wired adapter #1
allow-hotplug eth0
no-auto-down eth0
iface eth0 inet static
address 192.168.2.19
netmask 255.255.255.0
gateway 192.168.2.1
dns-nameservers 192.168.2.1
#	hwaddress ether # if you want to set MAC manually
#	pre-up /sbin/ifconfig eth0 mtu 3838 # setting MTU for DHCP, static just: mtu 3838


# Wireless adapter #1
# Armbian ships with network-manager installed by default. To save you time
# and hassles consider using 'sudo nmtui' instead of configuring Wi-Fi settings
# manually. The below lines are only meant as an example how configuration could
# be done in an anachronistic way:
# 
#allow-hotplug wlan0
#iface wlan0 inet dhcp
#address 192.168.0.100
#netmask 255.255.255.0
#gateway 192.168.0.1
#dns-nameservers 8.8.8.8 8.8.4.4
#   wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf
# Disable power saving on compatible chipsets (prevents SSH/connection dropouts over WiFi)
#wireless-mode Managed
#wireless-power off

# Local loopback
auto lo
iface lo inet loopback
```

- 保存→上传替换

> 此时没有提示，会直接覆盖。

- 重启

```
reboot
```

### 02 设置DNS

- 用ssh登入n1

- 修改`/etc`下的修改resolv.conf文件

```
vi /etc/resolv.conf
```

- 按`i`进入编辑模式，添加`search lan`并改主路由ip192.168.2.1

```
# Generated by NetworkManager
search lan
nameserver 192.168.2.1
```

### 03 查看网关和DNS

> 此时，网关和DNS由主路由负责

- 查看网关

```
route -n
```

- 查看DNS

```
nslookup www.baidu.com
```

## 4. 安装Docker版openwrt

### 01 拉取op镜像

- 拉取openwrt镜像

```
docker pull kanshudj/n1-openwrtgateway:r9.10.1
```

- 设置网卡：开启网卡混杂模式

```
ip link set eth0 promisc on
```

```
modprobe pppoe
```

- 设置网关：新建好一个与主路由网段一样的给旁路由用的网络

```
docker network create -d macvlan --subnet=192.168.2.0/24 --gateway=192.168.2.1 -o parent=eth0 macnet
```

> 2.0，2.1中的2是主路由网段

- 运行docker容器

```
docker run --restart always -d --network macnet --privileged kanshudj/n1-openwrtgateway:r9.10.1 /sbin/init
```



###  02 配置 Openwrt 

> chrome进入vi可能存在问题，可以换edge浏览器解决。

- 登入docker图形管理界面

```
n1的ip:9000
```

- 点[container]
- 选择刚导入的镜像→ 点击 `>_` → 点击 [Connect]

![](https://raw.githubusercontent.com/jkdigger/picForBlog/master/images/20191126235631.png)

- 按i改网关信息

```
vi /etc/config/network
```

- 找到3处包含192.168.X.X的地方，输入i进入编辑，同样将**x**改为你主路由的网段

```
config interface 'lan'
        option type 'bridge'
        option ifname 'eth0'
        option proto 'static'
        option ipaddr '192.168.X.2'
        option netmask '255.255.255.0'
        option gateway '192.168.X.1'
        option dns '114.114.114.114 223.5.5.5'
```

- 按`Esc`，输入`:wq!`保存并退出编辑
- 点击 [disconnect]
- 在 containers处：勾选op→点击 [restart]

### 03 登入openwrt

- 浏览器输入 `192.168.x.2` 即可进入openwrt

> 用户名 root
>
> 密码 password

## 参考资料

-  [梁非凡n1玩法](https://github.com/real-pin1group/3000web/wiki/playerdev_n1) 